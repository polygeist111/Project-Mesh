


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Kover HTML Report Coverage Report > MainActivity</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: Kover HTML Report<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">release.com.greybox.projectmesh</a>
</div>

<h1>Coverage Summary for Class: MainActivity (release.com.greybox.projectmesh)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
  <tr>
    <td class="name">MainActivity$onCreate$$inlined$instance$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$$inlined$instance$default$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$3$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$4$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$5$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$6$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$7$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$4$8$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$currentScreen$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$hasRunBefore$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$onCreate$2$localeState$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/160)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.greybox.projectmesh
&nbsp;
&nbsp;import android.annotation.SuppressLint
&nbsp;import android.app.AlertDialog
&nbsp;import android.content.Context
&nbsp;import android.content.Context.MODE_PRIVATE
&nbsp;import android.content.Intent
&nbsp;import android.content.SharedPreferences
&nbsp;import android.net.Uri
&nbsp;import android.os.Build
&nbsp;import android.os.Bundle
&nbsp;import android.os.Environment
&nbsp;import android.os.PowerManager
&nbsp;import android.provider.Settings
&nbsp;import android.util.Log
&nbsp;import android.widget.Toast
&nbsp;import androidx.activity.ComponentActivity
&nbsp;import androidx.activity.compose.setContent
&nbsp;import androidx.compose.foundation.layout.Column
&nbsp;import androidx.compose.foundation.layout.padding
&nbsp;import androidx.compose.material3.Button
&nbsp;import androidx.compose.material3.Scaffold
&nbsp;import androidx.compose.material3.Text
&nbsp;import androidx.compose.material3.TextField
&nbsp;import androidx.compose.runtime.Composable
&nbsp;import androidx.compose.runtime.LaunchedEffect
&nbsp;import androidx.compose.runtime.collectAsState
&nbsp;import androidx.compose.runtime.getValue
&nbsp;import androidx.compose.runtime.key
&nbsp;import androidx.compose.runtime.mutableStateOf
&nbsp;import androidx.compose.runtime.remember
&nbsp;import androidx.compose.runtime.saveable.rememberSaveable
&nbsp;import androidx.compose.runtime.setValue
&nbsp;import androidx.compose.ui.Modifier
&nbsp;import androidx.compose.ui.platform.LocalContext
&nbsp;import androidx.lifecycle.viewmodel.compose.viewModel
&nbsp;import androidx.navigation.compose.NavHost
&nbsp;import androidx.navigation.compose.composable
&nbsp;import androidx.navigation.compose.rememberNavController
&nbsp;import com.greybox.projectmesh.debug.CrashHandler
&nbsp;import com.greybox.projectmesh.debug.CrashScreenActivity
&nbsp;import com.greybox.projectmesh.navigation.BottomNavItem
&nbsp;import com.greybox.projectmesh.navigation.BottomNavigationBar
&nbsp;import com.greybox.projectmesh.server.AppServer
&nbsp;import com.greybox.projectmesh.ui.theme.AppTheme
&nbsp;import com.greybox.projectmesh.ui.theme.ProjectMeshTheme
&nbsp;import com.greybox.projectmesh.viewModel.SharedUriViewModel
&nbsp;import com.greybox.projectmesh.messaging.ui.screens.ChatScreen
&nbsp;import com.greybox.projectmesh.views.HomeScreen
&nbsp;import com.greybox.projectmesh.views.SettingsScreen
&nbsp;import com.greybox.projectmesh.views.NetworkScreen
&nbsp;import com.greybox.projectmesh.views.PingScreen
&nbsp;import com.greybox.projectmesh.views.ReceiveScreen
&nbsp;import com.greybox.projectmesh.views.SelectDestNodeScreen
&nbsp;import com.greybox.projectmesh.views.SendScreen
&nbsp;import com.greybox.projectmesh.views.OnboardingScreen
&nbsp;import com.greybox.projectmesh.testing.TestDeviceService
&nbsp;import org.kodein.di.DI
&nbsp;import org.kodein.di.DIAware
&nbsp;import org.kodein.di.android.closestDI
&nbsp;import org.kodein.di.compose.withDI
&nbsp;import org.kodein.di.instance
&nbsp;import java.io.File
&nbsp;import java.util.Locale
&nbsp;import java.net.InetAddress
&nbsp;import com.greybox.projectmesh.messaging.ui.screens.ChatNodeListScreen
&nbsp;import com.greybox.projectmesh.messaging.ui.screens.ConversationsHomeScreen
&nbsp;import com.greybox.projectmesh.user.UserRepository
&nbsp;import kotlinx.coroutines.CoroutineScope
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.launch
&nbsp;import androidx.compose.runtime.getValue
&nbsp;import androidx.compose.runtime.mutableStateOf
&nbsp;import androidx.compose.runtime.setValue
&nbsp;import androidx.compose.runtime.remember
&nbsp;import kotlinx.coroutines.launch
&nbsp;import androidx.compose.runtime.rememberCoroutineScope
&nbsp;import androidx.compose.foundation.layout.Box
&nbsp;import androidx.compose.foundation.layout.fillMaxSize
&nbsp;import androidx.compose.material3.CircularProgressIndicator
&nbsp;import androidx.compose.runtime.getValue
&nbsp;import androidx.compose.runtime.mutableStateOf
&nbsp;import androidx.compose.runtime.setValue
&nbsp;import androidx.compose.runtime.remember
&nbsp;import androidx.compose.runtime.rememberCoroutineScope
&nbsp;import androidx.compose.ui.Alignment
&nbsp;import androidx.compose.ui.platform.LocalSavedStateRegistryOwner
&nbsp;import androidx.lifecycle.lifecycleScope
&nbsp;import kotlinx.coroutines.launch
&nbsp;import com.greybox.projectmesh.messaging.data.entities.Conversation
&nbsp;import com.greybox.projectmesh.messaging.ui.viewmodels.ChatScreenViewModel
&nbsp;import com.greybox.projectmesh.views.LogScreen
&nbsp;
&nbsp;
&nbsp;import com.greybox.projectmesh.views.RequestPermissionsScreen
&nbsp;import org.kodein.di.compose.localDI
&nbsp;
&nbsp;class MainActivity : ComponentActivity(), DIAware {
&nbsp;    override val di by closestDI()
&nbsp;    override fun onCreate(savedInstanceState: Bundle?) {
&nbsp;        setTheme(R.style.Theme_ProjectMesh)
&nbsp;        super.onCreate(savedInstanceState)
&nbsp;        // crash screen
&nbsp;        CrashHandler.init(applicationContext, CrashScreenActivity::class.java)
&nbsp;        val settingPref: SharedPreferences by di.instance(tag = &quot;settings&quot;)
&nbsp;        val appServer: AppServer by di.instance()
&nbsp;        // Run this task asynchronously (default directory creation)
<b class="nc">&nbsp;        lifecycleScope.launch(Dispatchers.IO) {</b>
<b class="nc">&nbsp;            ensureDefaultDirectory()</b>
&nbsp;        }
&nbsp;        //Initialize test device:
&nbsp;        TestDeviceService.initialize()
&nbsp;        Log.d(&quot;MainActivity&quot;, &quot;Test device initialized&quot;)
&nbsp;        setContent {
&nbsp;            val meshPrefs = getSharedPreferences(&quot;project_mesh_prefs&quot;, MODE_PRIVATE)
&nbsp;            var hasRunBefore by rememberSaveable {
<b class="nc">&nbsp;                mutableStateOf(meshPrefs.getBoolean(&quot;hasRunBefore&quot;, false))</b>
&nbsp;            }
&nbsp;            // Check if the app was launched from a notification
&nbsp;            val launchedFromNotification = intent?.getBooleanExtra(&quot;from_notification&quot;, false) ?: false
&nbsp;            // Request all permission in order
&nbsp;            RequestPermissionsScreen(skipPermissions = launchedFromNotification)
&nbsp;            var appTheme by remember {
&nbsp;                mutableStateOf(AppTheme.valueOf(
&nbsp;                    settingPref.getString(&quot;app_theme&quot;, AppTheme.SYSTEM.name) ?:
&nbsp;                    AppTheme.SYSTEM.name))
&nbsp;            }
&nbsp;            var languageCode by remember {
&nbsp;                mutableStateOf(settingPref.getString(
&nbsp;                    &quot;language&quot;, &quot;en&quot;) ?: &quot;en&quot;)
&nbsp;            }
&nbsp;            var restartServerKey by remember {mutableStateOf(0)}
&nbsp;            var deviceName by remember {
&nbsp;                mutableStateOf(settingPref.getString(&quot;device_name&quot;, Build.MODEL) ?: Build.MODEL)
&nbsp;            }
&nbsp;
&nbsp;            var autoFinish by remember {
&nbsp;                mutableStateOf(settingPref.getBoolean(&quot;auto_finish&quot;, false))
&nbsp;            }
&nbsp;
&nbsp;            var saveToFolder by remember {
&nbsp;                mutableStateOf(
&nbsp;                    settingPref.getString(&quot;save_to_folder&quot;, null)
&nbsp;                        ?: &quot;${Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)}/Project Mesh&quot;
&nbsp;                )
&nbsp;            }
&nbsp;
&nbsp;            // State to trigger recomposition when locale changes
<b class="nc">&nbsp;            var localeState by rememberSaveable { mutableStateOf(Locale.getDefault()) }</b>
&nbsp;
&nbsp;            // Remember the current screen across recompositions
<b class="nc">&nbsp;            var currentScreen by rememberSaveable { mutableStateOf(BottomNavItem.Home.route) }</b>
<b class="nc">&nbsp;            LaunchedEffect(intent?.getStringExtra(&quot;navigateTo&quot;)) {</b>
<b class="nc">&nbsp;                if (intent?.getStringExtra(&quot;navigateTo&quot;) == BottomNavItem.Receive.route) {</b>
<b class="nc">&nbsp;                    currentScreen = BottomNavItem.Receive.route</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            //check for special navigation intents
&nbsp;            val action = intent.action
&nbsp;            if (action == &quot;OPEN_CHAT_SCREEN&quot;) {
&nbsp;                val ip = intent.getStringExtra(&quot;ip&quot;)
&nbsp;                if (ip != null) {
&nbsp;                    try {
&nbsp;                        // Try to create InetAddress to validate it first
&nbsp;                        InetAddress.getByName(ip)
&nbsp;                        // If that succeeds, navigate to chat screen with this IP
&nbsp;                        val route = &quot;chatScreen/$ip&quot;
&nbsp;                        currentScreen = route
&nbsp;                    } catch (e: Exception) {
&nbsp;                        Log.e(&quot;MainActivity&quot;, &quot;Invalid IP address in intent: $ip&quot;, e)
&nbsp;                        // Fall back to home screen
&nbsp;                        currentScreen = BottomNavItem.Home.route
&nbsp;                    }
&nbsp;                }
&nbsp;            } else if (action == &quot;OPEN_CHAT_CONVERSATION&quot;) {
&nbsp;                val conversationId = intent.getStringExtra(&quot;conversationId&quot;)
&nbsp;                if (conversationId != null) {
&nbsp;                    // Navigate to chat screen with this conversation ID
&nbsp;                    val route = &quot;chatScreen/$conversationId&quot;
&nbsp;                    currentScreen = route
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            LaunchedEffect(restartServerKey) {</b>
<b class="nc">&nbsp;                if (restartServerKey &gt; 0){</b>
<b class="nc">&nbsp;                    appServer.restart()</b>
<b class="nc">&nbsp;                    Toast.makeText(this@MainActivity, &quot;Server restart complete&quot;, Toast.LENGTH_SHORT).show()</b>
&nbsp;                }
&nbsp;            }
&nbsp;            // Observe language changes and apply locale
<b class="nc">&nbsp;            LaunchedEffect(languageCode) {</b>
<b class="nc">&nbsp;                localeState = updateLocale(languageCode)</b>
&nbsp;            }
&nbsp;            key(localeState) {
&nbsp;                ProjectMeshTheme(appTheme = appTheme) {
&nbsp;                    if (!hasRunBefore) {
&nbsp;                        OnboardingScreen(
<b class="nc">&nbsp;                            onComplete = {meshPrefs.edit().putBoolean(&quot;hasRunBefore&quot;, true).apply()</b>
<b class="nc">&nbsp;                                hasRunBefore = true }</b>
&nbsp;                        )
&nbsp;                    }
&nbsp;                    else{
&nbsp;                        BottomNavApp(
&nbsp;                            di,
&nbsp;                            startDestination = currentScreen,
<b class="nc">&nbsp;                            onThemeChange = { selectedTheme -&gt; appTheme = selectedTheme},</b>
<b class="nc">&nbsp;                            onLanguageChange = { selectedLanguage -&gt;  languageCode = selectedLanguage},</b>
&nbsp;                            onNavigateToScreen = {screen -&gt;
<b class="nc">&nbsp;                                currentScreen = screen },</b>
<b class="nc">&nbsp;                            onRestartServer = {restartServerKey++},</b>
<b class="nc">&nbsp;                            onDeviceNameChange = {deviceName = it},</b>
&nbsp;                            deviceName = deviceName,
<b class="nc">&nbsp;                            onAutoFinishChange = {autoFinish = it},</b>
<b class="nc">&nbsp;                            onSaveToFolderChange = {saveToFolder = it}</b>
&nbsp;                        )
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun ensureDefaultDirectory() {
&nbsp;        val defaultDirectory = File(
&nbsp;            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
&nbsp;            &quot;Project Mesh&quot;
&nbsp;        )
&nbsp;        if (!defaultDirectory.exists()) {
&nbsp;            // Create the directory if it doesn&#39;t exist
&nbsp;            if (defaultDirectory.mkdirs()) {
&nbsp;                Log.d(&quot;DirectoryCheck&quot;, &quot;Default directory created: ${defaultDirectory.absolutePath}&quot;)
&nbsp;            }
&nbsp;            else {
&nbsp;                Log.e(&quot;DirectoryCheck&quot;, &quot;Failed to create default directory: ${defaultDirectory.absolutePath}&quot;)
&nbsp;            }
&nbsp;        }
&nbsp;        else {
&nbsp;            Log.d(&quot;DirectoryCheck&quot;, &quot;Default directory already exists: ${defaultDirectory.absolutePath}&quot;)
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun updateLocale(languageCode: String): Locale {
&nbsp;        val locale = Locale(languageCode)
&nbsp;        val config = resources.configuration
&nbsp;        config.setLocale(locale)
&nbsp;        @Suppress(&quot;DEPRECATION&quot;)
&nbsp;        resources.updateConfiguration(config, resources.displayMetrics)
&nbsp;        return locale
&nbsp;    }
&nbsp;}
&nbsp;
&nbsp;@Composable
&nbsp;fun BottomNavApp(di: DI,
&nbsp;                 startDestination: String,
&nbsp;                 onThemeChange: (AppTheme) -&gt; Unit,
&nbsp;                 onLanguageChange: (String) -&gt; Unit,
&nbsp;                 onNavigateToScreen: (String) -&gt; Unit,
&nbsp;                 onRestartServer: () -&gt; Unit,
&nbsp;                 onDeviceNameChange: (String) -&gt; Unit,
&nbsp;                 deviceName: String,
&nbsp;                 onAutoFinishChange: (Boolean) -&gt; Unit,
&nbsp;                 onSaveToFolderChange: (String) -&gt; Unit
&nbsp;) = withDI(di)
&nbsp;{
&nbsp;    val appServer: AppServer by di.instance()
&nbsp;    val navController = rememberNavController()
&nbsp;    // Observe the current route directly through the back stack entry
&nbsp;    val currentRoute = navController.currentBackStackEntryFlow.collectAsState(initial = null)
&nbsp;
&nbsp;    LaunchedEffect(currentRoute.value?.destination?.route) {
&nbsp;        if(currentRoute.value?.destination?.route == BottomNavItem.Settings.route){
&nbsp;            currentRoute.value?.destination?.route?.let { route -&gt;
&nbsp;                onNavigateToScreen(route)
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    Scaffold(
&nbsp;        bottomBar = { BottomNavigationBar(navController) }
&nbsp;    ){ innerPadding -&gt;
&nbsp;        NavHost(navController, startDestination = startDestination, Modifier.padding(innerPadding))
&nbsp;        {
&nbsp;            composable(BottomNavItem.Home.route) { HomeScreen(deviceName = deviceName) }
&nbsp;            composable(BottomNavItem.Network.route) {
&nbsp;                // Just call NetworkScreen with no click callback
&nbsp;                NetworkScreen(
&nbsp;                    onNodeClick = {ip -&gt; navController.navigate(&quot;pingScreen/$ip&quot;)}
&nbsp;                )
&nbsp;            }
&nbsp;            composable(&quot;chatScreen/{ip}&quot;){ entry -&gt;
&nbsp;                val ip = entry.arguments?.getString(&quot;ip&quot;)
&nbsp;                    ?: throw IllegalArgumentException(&quot;Invalid address&quot;)
&nbsp;
&nbsp;                Log.d(&quot;Navigation&quot;, &quot;Navigating to chatScreen with parameter: $ip&quot;)
&nbsp;
&nbsp;                //determine if this is an ip address
&nbsp;                val isValidIpAddress = ip.matches(Regex(&quot;^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\$&quot;))
&nbsp;                Log.d(&quot;Navigation&quot;, &quot;Is valid IP address: $isValidIpAddress&quot;)
&nbsp;
&nbsp;
&nbsp;                if(isValidIpAddress) {
&nbsp;                    Log.d(&quot;Navigation&quot;, &quot;Showing chat for IP address: $ip&quot;)
&nbsp;                    // This is a valid IP address, use normal chat screen
&nbsp;                    ChatScreen(
&nbsp;                        virtualAddress = InetAddress.getByName(ip),
&nbsp;                        onClickButton = {
&nbsp;                            navController.navigate(&quot;pingScreen/${ip}&quot;)
&nbsp;                        }
&nbsp;                    )
&nbsp;                } else {
&nbsp;                    Log.d(&quot;Navigation&quot;, &quot;Showing chat for conversation ID: $ip&quot;)
&nbsp;                    //conversation id: handle offline chat
&nbsp;                    ConversationChatScreen(
&nbsp;                        conversationId = ip,
&nbsp;                        onBackClick = {
&nbsp;                            Log.d(&quot;Navigation&quot;, &quot;Navigating back from conversation&quot;)
&nbsp;                            navController.popBackStack()
&nbsp;                        }
&nbsp;                    )
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            composable(&quot;pingScreen/{ip}&quot;){ entry -&gt;
&nbsp;                val ip = entry.arguments?.getString(&quot;ip&quot;)
&nbsp;                    ?: throw IllegalArgumentException(&quot;Invalid address&quot;)
&nbsp;                PingScreen(
&nbsp;                    virtualAddress = InetAddress.getByName(ip)
&nbsp;                )
&nbsp;            }
&nbsp;
&nbsp;            composable(BottomNavItem.Send.route) {
&nbsp;                val activity = LocalContext.current as ComponentActivity
&nbsp;                val sharedUrisViewModel: SharedUriViewModel = viewModel(activity)
&nbsp;                SendScreen(
&nbsp;                    onSwitchToSelectDestNode = { uris -&gt;
&nbsp;                        Log.d(&quot;uri_track_nav_send&quot;, &quot;size: &quot; + uris.size.toString())
&nbsp;                        Log.d(&quot;uri_track_nav_send&quot;, &quot;List: $uris&quot;)
&nbsp;                        sharedUrisViewModel.setUris(uris)
&nbsp;                        navController.navigate(&quot;selectDestNode&quot;)
&nbsp;                    }
&nbsp;                )
&nbsp;            }
&nbsp;            composable(&quot;selectDestNode&quot;){
&nbsp;                val activity = LocalContext.current as ComponentActivity
&nbsp;                val sharedUrisViewModel: SharedUriViewModel = viewModel(activity)
&nbsp;                val sendUris by sharedUrisViewModel.uris.collectAsState()
&nbsp;                Log.d(&quot;uri_track_nav_selectDestNode&quot;, &quot;size: &quot; + sendUris.size.toString())
&nbsp;                Log.d(&quot;uri_track_nav_selectDestNode&quot;, &quot;List: $sendUris&quot;)
&nbsp;                SelectDestNodeScreen(
&nbsp;                    uris = sendUris,
&nbsp;                    popBackWhenDone = {navController.popBackStack()},
&nbsp;                )
&nbsp;            }
&nbsp;            composable(BottomNavItem.Receive.route) { ReceiveScreen(
&nbsp;                onAutoFinishChange = onAutoFinishChange
&nbsp;            ) }
&nbsp;            composable(BottomNavItem.Log.route) {
&nbsp;                LogScreen()
&nbsp;            }
&nbsp;            composable(BottomNavItem.Settings.route) {
&nbsp;                // Retrieve required instances from DI with explicit types
&nbsp;                val settingsPrefs: SharedPreferences by di.instance&lt;SharedPreferences&gt;(tag = &quot;settings&quot;)
&nbsp;                val userRepository: UserRepository by di.instance&lt;UserRepository&gt;()
&nbsp;                SettingsScreen(
&nbsp;                    onThemeChange = onThemeChange,
&nbsp;                    onLanguageChange = onLanguageChange,
&nbsp;                    onRestartServer = onRestartServer,
&nbsp;                    onDeviceNameChange = { newDeviceName -&gt;
&nbsp;                        Log.d(&quot;BottomNavApp&quot;, &quot;Device name changed to: $newDeviceName&quot;)
&nbsp;                        // Retrieve the local UUID from SharedPreferences
&nbsp;                        val localUuid = settingsPrefs.getString(&quot;UUID&quot;, null)
&nbsp;                        if (localUuid != null) {
&nbsp;                            // Update the local user info and broadcast in an IO coroutine
&nbsp;                            CoroutineScope(Dispatchers.IO).launch {
&nbsp;                                // 1. Update the local user in the database
&nbsp;                                userRepository.insertOrUpdateUser(
&nbsp;                                    uuid = localUuid,
&nbsp;                                    name = newDeviceName,
&nbsp;                                    address = appServer.localVirtualAddr.hostAddress  // &lt;-- local IP here
&nbsp;                                )
&nbsp;                                Log.d(&quot;BottomNavApp&quot;, &quot;Updated local user with new name: $newDeviceName&quot;)
&nbsp;
&nbsp;                                // 2. Retrieve all connected users (those with a non-null address)
&nbsp;                                val connectedUsers = userRepository.getAllConnectedUsers()
&nbsp;                                connectedUsers.forEach { user -&gt;
&nbsp;                                    user.address?.let { ip -&gt;
&nbsp;                                        try {
&nbsp;                                            val remoteAddr = InetAddress.getByName(ip)
&nbsp;                                            Log.d(&quot;BottomNavApp&quot;, &quot;Broadcasting updated info to: $ip&quot;)
&nbsp;                                            appServer.pushUserInfoTo(remoteAddr)
&nbsp;                                        } catch (e: Exception) {
&nbsp;                                            Log.e(&quot;BottomNavApp&quot;, &quot;Error processing IP address: $ip&quot;, e)
&nbsp;                                        }
&nbsp;                                    }
&nbsp;                                }
&nbsp;                            }
&nbsp;                        } else {
&nbsp;                            Log.e(&quot;BottomNavApp&quot;, &quot;Local UUID not found; cannot update user&quot;)
&nbsp;                        }
&nbsp;                    },
&nbsp;                    onAutoFinishChange = onAutoFinishChange,
&nbsp;                    onSaveToFolderChange = onSaveToFolderChange,
&nbsp;                )
&nbsp;            }
&nbsp;            //I&#39;m guessing I can put my Chat button here?
&nbsp;            composable(BottomNavItem.Chat.route) {
&nbsp;                //latest status of DeviceStatus manager
&nbsp;                val deviceStatusRefreshTrigger = DeviceStatusManager.deviceStatusMap.collectAsState().value
&nbsp;                // Show a list of nodes, let the user pick one
&nbsp;                ConversationsHomeScreen(
&nbsp;                    onConversationSelected = { userIdentifier -&gt;
&nbsp;                        // userIdentifier will be either an IP address (for online users)
&nbsp;                        // or a conversation ID (for offline users)
&nbsp;                        Log.d(&quot;Navigation&quot;, &quot;Selected conversation/user: $userIdentifier&quot;)
&nbsp;                        //navigate to the chat screen with this identifier
&nbsp;                        navController.navigate(&quot;chatScreen/${userIdentifier}&quot;)
&nbsp;                    }
&nbsp;                )
&nbsp;                /*
&nbsp;                ChatNodeListScreen(
&nbsp;                    onNodeSelected = { ip -&gt;
&nbsp;                        val remoteAddr = InetAddress.getByName(ip)
&nbsp;                        Log.d(&quot;ChatHandshake&quot;, &quot;Node selected with IP: $ip, remoteAddr: $remoteAddr&quot;)
&nbsp;
&nbsp;                        // Request remote user info
&nbsp;                        Log.d(&quot;ChatHandshake&quot;, &quot;Requesting remote user info from: ${remoteAddr.hostAddress}&quot;)
&nbsp;                        appServer.requestRemoteUserInfo(remoteAddr)
&nbsp;
&nbsp;                        // Push local user info to remote node
&nbsp;                        Log.d(&quot;ChatHandshake&quot;, &quot;Pushing local user info to: ${remoteAddr.hostAddress}&quot;)
&nbsp;                        appServer.pushUserInfoTo(remoteAddr)
&nbsp;
&nbsp;                        // Navigate to the chat screen
&nbsp;                        navController.navigate(&quot;chatScreen/$ip&quot;)
&nbsp;                    }
&nbsp;
&nbsp;                )
&nbsp;                */
&nbsp;            }
&nbsp;
&nbsp;            //handle ip address chat screen properly
&nbsp;            composable(&quot;chatScreen/{ip}&quot;){ entry -&gt;
&nbsp;                val ipParam = entry.arguments?.getString(&quot;ip&quot;)
&nbsp;                if (ipParam == null) {
&nbsp;                    // Handle missing parameter
&nbsp;                    Text(&quot;Error: Missing address parameter&quot;)
&nbsp;                } else {
&nbsp;                    // Check if this is an IP address or conversation ID
&nbsp;                    val isValidIpAddress = ipParam.matches(Regex(&quot;^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\$&quot;))
&nbsp;
&nbsp;                    val validatedAddress = remember(ipParam) {
&nbsp;                        if (isValidIpAddress) {
&nbsp;                            try {
&nbsp;                                InetAddress.getByName(ipParam)
&nbsp;                            } catch (e: Exception) {
&nbsp;                                Log.e(&quot;Navigation&quot;, &quot;Error creating address from parameter: $ipParam&quot;, e)
&nbsp;                                null
&nbsp;                            }
&nbsp;                        } else {
&nbsp;                            null
&nbsp;                        }
&nbsp;                    }
&nbsp;                    if (isValidIpAddress &amp;&amp; validatedAddress != null) {
&nbsp;                        // It&#39;s a valid IP address
&nbsp;                        ChatScreen(
&nbsp;                            virtualAddress = validatedAddress,
&nbsp;                            onClickButton = {
&nbsp;                                navController.navigate(&quot;pingScreen/${ipParam}&quot;)
&nbsp;                            }
&nbsp;                        )
&nbsp;                    } else {
&nbsp;                        // Handle as conversation ID
&nbsp;                        ConversationChatScreen(
&nbsp;                            conversationId = ipParam,
&nbsp;                            onBackClick = {
&nbsp;                                navController.popBackStack()
&nbsp;                            }
&nbsp;                        )
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
&nbsp;
&nbsp;
&nbsp;@Composable
&nbsp;fun ConversationChatScreen (
&nbsp;        conversationId: String,
&nbsp;        onBackClick: () -&gt; Unit
&nbsp;){
&nbsp;    Log.d(&quot;ConversationChatScreen&quot;, &quot;Starting to load conversation: $conversationId&quot;)
&nbsp;
&nbsp;    var conversationState = remember { mutableStateOf&lt;Conversation?&gt;(null) }
&nbsp;    var isLoading = remember { mutableStateOf(true) }
&nbsp;    var errorMessage = remember { mutableStateOf&lt;String?&gt;(null) }
&nbsp;    //val conversation = conversationState.value
&nbsp;    val context = LocalContext.current
&nbsp;
&nbsp;    val coroutineScope = rememberCoroutineScope()
&nbsp;
&nbsp;    // Load the conversation data
&nbsp;    LaunchedEffect(conversationId) {
&nbsp;        Log.d(&quot;ConversationChatScreen&quot;, &quot;LaunchedEffect triggered for ID: $conversationId&quot;)
&nbsp;        coroutineScope.launch {
&nbsp;            try {
&nbsp;                Log.d(&quot;ConversationChatScreen&quot;, &quot;Attempting to fetch conversation&quot;)
&nbsp;                val result = GlobalApp.GlobalUserRepo.conversationRepository.getConversationById(conversationId)
&nbsp;                Log.d(&quot;ConversationChatScreen&quot;, &quot;Fetch result: ${result != null}&quot;)
&nbsp;                //conversationState.value = result
&nbsp;
&nbsp;                if (result == null) {
&nbsp;                    errorMessage.value = &quot;Conversation not found&quot;
&nbsp;                    isLoading.value = false
&nbsp;                    /*
&nbsp;                    Log.e(&quot;ConversationChatScreen&quot;, &quot;Conversation not found: $conversationId&quot;)
&nbsp;                    Toast.makeText(
&nbsp;                        context,
&nbsp;                        &quot;Conversation not found&quot;,
&nbsp;                        Toast.LENGTH_SHORT
&nbsp;                    ).show()
&nbsp;                    onBackClick()
&nbsp;                    */
&nbsp;                }else {
&nbsp;                    conversationState.value = result
&nbsp;                    isLoading.value = false
&nbsp;                    Log.d(&quot;ConversationChatScreen&quot;, &quot;Loaded conversation: ${result.userName}, online=${result.isOnline}&quot;)
&nbsp;                }
&nbsp;            } catch (e: Exception) {
&nbsp;                Log.e(&quot;ConversationChatScreen&quot;, &quot;Error loading conversation&quot;, e)
&nbsp;                errorMessage.value = e.message
&nbsp;                isLoading.value = false
&nbsp;                /*
&nbsp;                Toast.makeText(
&nbsp;                    context,
&nbsp;                    &quot;Error loading conversation: ${e.message}&quot;,
&nbsp;                    Toast.LENGTH_SHORT
&nbsp;                ).show()
&nbsp;                onBackClick()
&nbsp;                 */
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // Show loading state while fetching conversation
&nbsp;    if (isLoading.value) {
&nbsp;        Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
&nbsp;            CircularProgressIndicator()
&nbsp;        }
&nbsp;        return
&nbsp;    }
&nbsp;
&nbsp;    //show error if loading failed
&nbsp;    if (errorMessage.value != null) {
&nbsp;        Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
&nbsp;            Column(horizontalAlignment = Alignment.CenterHorizontally) {
&nbsp;                Text(&quot;Error: ${errorMessage.value}&quot;)
&nbsp;                Button(onClick = onBackClick) {
&nbsp;                    Text(&quot;Go Back&quot;)
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        return
&nbsp;    }
&nbsp;
&nbsp;    //get the conversation from state
&nbsp;    val conversation = conversationState.value
&nbsp;    if (conversation == null) {
&nbsp;        Toast.makeText(context, &quot;Conversation not found&quot;, Toast.LENGTH_SHORT).show()
&nbsp;        onBackClick()
&nbsp;        return
&nbsp;    }
&nbsp;
&nbsp;    val shouldCheckDeviceStatus = remember {
&nbsp;        // Only check for devices with real IP addresses, not placeholder or offline devices
&nbsp;        conversation.userAddress != null &amp;&amp;
&nbsp;                conversation.userAddress != &quot;0.0.0.0&quot; &amp;&amp;
&nbsp;                conversation.userAddress != TestDeviceService.TEST_DEVICE_IP_OFFLINE
&nbsp;    }
&nbsp;
&nbsp;    // Initialize isUserOnline based on conversation state first
&nbsp;    var isUserOnline by remember { mutableStateOf(conversation.isOnline) }
&nbsp;
&nbsp;    // If we should check device status, observe DeviceStatusManager
&nbsp;    if (shouldCheckDeviceStatus) {
&nbsp;        val deviceStatusMap by DeviceStatusManager.deviceStatusMap.collectAsState()
&nbsp;        // Update isUserOnline based on DeviceStatusManager
&nbsp;        LaunchedEffect(deviceStatusMap) {
&nbsp;            conversation.userAddress?.let { ipAddress -&gt;
&nbsp;                val statusFromManager = deviceStatusMap[ipAddress] ?: false
&nbsp;                if (isUserOnline != statusFromManager) {
&nbsp;                    Log.d(&quot;ConversationChatScreen&quot;, &quot;Device status changed for ${conversation.userName}: ${if (statusFromManager) &quot;online&quot; else &quot;offline&quot;}&quot;)
&nbsp;                    isUserOnline = statusFromManager
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // Create a virtual address based on the conversation data
&nbsp;    val virtualAddress = if (conversation?.userAddress.isNullOrEmpty()) {
&nbsp;        //use offline test device address if this is the offline test conversation
&nbsp;        if (conversation.userName == TestDeviceService.TEST_DEVICE_NAME_OFFLINE) {
&nbsp;            Log.d(&quot;ConversationChatScreen&quot;, &quot;Using offline test device address&quot;)
&nbsp;            InetAddress.getByName(TestDeviceService.TEST_DEVICE_IP_OFFLINE)
&nbsp;        } else {
&nbsp;            //use a placeholder address for regular offline users
&nbsp;            Log.d(&quot;ConversationChatScreen&quot;, &quot;Using placeholder address for offline user&quot;)
&nbsp;            InetAddress.getByName(&quot;0.0.0.0&quot;)
&nbsp;        }
&nbsp;    } else {
&nbsp;        //use the actual address if available
&nbsp;        Log.d(&quot;ConversationChatScreen&quot;, &quot;Using actual address: ${conversation.userAddress}&quot;)
&nbsp;        InetAddress.getByName(conversation.userAddress)
&nbsp;    }
&nbsp;
&nbsp;    Log.d(&quot;ConversationChatScreen&quot;, &quot;Showing chat screen for: ${conversation.userName}&quot;)
&nbsp;
&nbsp;    // Show the chat screen
&nbsp;    ChatScreen(
&nbsp;        virtualAddress = virtualAddress,
&nbsp;        userName = conversation.userName,
&nbsp;        isOffline = !conversation.isOnline,
&nbsp;        onClickButton = {
&nbsp;            // Disable ping for offline users
&nbsp;            Toast.makeText(
&nbsp;                context,
&nbsp;                &quot;Cannot ping offline users&quot;,
&nbsp;                Toast.LENGTH_SHORT
&nbsp;            ).show()
&nbsp;        },
&nbsp;        viewModel = viewModel(
&nbsp;            factory = ViewModelFactory(
&nbsp;                di = localDI(),
&nbsp;                owner = LocalSavedStateRegistryOwner.current,
&nbsp;                vmFactory = { di, savedStateHandle -&gt;
&nbsp;                    // Make sure to set the conversation ID in the savedStateHandle
&nbsp;                    savedStateHandle[&quot;conversationId&quot;] = conversationId
&nbsp;                    ChatScreenViewModel(di, savedStateHandle)
&nbsp;                },
&nbsp;                defaultArgs = Bundle().apply {
&nbsp;                    putSerializable(&quot;virtualAddress&quot;, virtualAddress)
&nbsp;                    putString(&quot;conversationId&quot;, conversationId)
&nbsp;                }
&nbsp;            )
&nbsp;        )
&nbsp;    )
&nbsp;}
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-29 23:35</div>
</div>
</body>
</html>
